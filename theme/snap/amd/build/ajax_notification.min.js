/**
 * This file is part of Moodle - http://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @package
 * @author    Guy Thomas
 * @copyright Copyright (c) 2016 Open LMS
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_snap/ajax_notification",["jquery","core/notification","core/ajax","core/templates","core/str","theme_snap/util"],(function($,notification,ajax,templates,str,util){var loginErrorShown=!1,loggingOut=!1,redirectInProgress=!1;return $(document).ready((function(){$("#snap-pm-logout").click((function(){loggingOut=!0}))})),{ifErrorShowBestMsg:function(response,failAction,failMsg){var dfd=$.Deferred();if(loginErrorShown)return dfd.resolve(!0),dfd.promise();if(loggingOut)return dfd.resolve(!0),dfd.promise();if("object"!=typeof response)try{var jsonObj=JSON.parse(response);response=jsonObj}catch(e){}if(void 0===response)return!1;if(response.errorcode&&"sitepolicynotagreed"===response.errorcode){var redirect=M.cfg.wwwroot+"/user/policy.php";return window.location!=redirect&&!redirectInProgress&&$("#primary-nav").is(":visible")?(window.location=redirect,redirectInProgress=!0,loginErrorShown=!0,dfd.resolve(!0)):dfd.resolve(!1),dfd.promise()}if(response.error||response.errorcode){if(M.snapTheme.forcePassChange){var pwdChangeUrl=M.cfg.wwwroot+"/login/change_password.php";return $("#snap-pm-content").length&&(str.get_string("forcepwdwarningpersonalmenu","theme_snap",pwdChangeUrl).then((function(forcePwdWarning){var alertMsg={message:forcePwdWarning,extraclasses:"force-pwd-warning"};return templates.render("core/notification_warning",alertMsg)})).then((function(result){$("#snap-pm-content").html("<br />"+result),dfd.resolve(!0)})),$("#snap-pm-content").is(":visible"))?(loginErrorShown=!0,dfd.promise()):(window.location!=pwdChangeUrl&&(window.location=pwdChangeUrl),loginErrorShown=!0,dfd.resolve(!0),dfd.promise())}return failAction=failAction||"",$.ajax({type:"POST",async:!0,data:{sesskey:M.cfg.sesskey,failedactionmsg:failAction},url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_loginstatus"}).then((function(thisResp){return loginErrorShown?(dfd.resolve(!0),dfd.promise()):thisResp.loggedin?function(response){var endfd=$.Deferred();if(failMsg)notification.alert(M.util.get_string("error","moodle"),failMsg,M.util.get_string("ok","moodle"));else if(response.backtrace)notification.exception(response);else{var errorstr;if(response.error)errorstr=response.error,response.stacktrace&&(errorstr="<div>"+errorstr+"<pre>"+response.stacktrace+"</pre></div>");else{if(!response.errorcode||!response.message)return endfd.resolve(!1),endfd.promise();errorstr=response.message}notification.alert(M.util.get_string("error","moodle"),errorstr,M.util.get_string("ok","moodle"))}return util.whenTrue((function(){return $(".moodle-dialogue-base").is(":visible")}),(function(){endfd.resolve(!0)}),!0),endfd.promise()}(response):($("<style>.confirmation-dialogue .confirmation-buttons input:nth-of-type(2), .moodle-dialogue-base.moodle-dialogue-confirm button.yui3-button.closebutton{ display : none }</style>").appendTo("head"),notification.confirm(thisResp.loggedouttitle,thisResp.loggedoutmsg,thisResp.loggedoutcontinue," ",(function(){window.location=M.cfg.wwwroot+"/login/index.php"})),loginErrorShown=!0,dfd.resolve(!0),dfd.promise())}))}return dfd.resolve(!1),dfd.promise()}}}));

//# sourceMappingURL=ajax_notification.min.js.map