/**
 * This file is part of Moodle - http://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @package
 * @copyright Copyright (c) 2016 Open LMS (https://www.openlms.net)
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_snap/pm_course_favorites",["jquery","core/ajax","core/notification","core/log","theme_snap/model_view","theme_snap/ajax_notification"],(function($,ajax,notification,log,mview,ajaxNotify){return function(){log.enableAll(!0);var getCardId=function(cardEl){return parseInt($(cardEl).find(".coursecard-body").data("courseid"))},getCardTitle=function(cardEl,lowerCase){void 0===lowerCase&&(lowerCase=!0);var title=$(cardEl).find(".coursecard-coursename").html();return lowerCase&&(title=title.toLowerCase()),title},moveCard=function(cardEl,listSelector,listSelectorWhenEmpty,prependWhenEmpty,onMoveComplete){var cardEls=$(listSelector),idx=function(cardEl,cards){if(0===cards.length)return-1;var sort=[],sortItem={};return cards.each((function(){sortItem={title:getCardTitle(this),card:this},sort.push(sortItem)})),sortItem={title:getCardTitle(cardEl),card:cardEl},sort.push(sortItem),sort.sort((function(a,b){var aId=getCardId(a.card),bId=getCardId(b.card);return a.title===b.title?aId===bId?0:aId>bId?1:-1:a.title>b.title?1:-1})),sort.indexOf(sortItem)}(cardEl,cardEls),insIdx=idx+1;log.debug("Moving card element into position "+insIdx+" of list (size = "+cardEls.length+") : "+listSelector),insIdx>0?insIdx<=cardEls.length?(log.debug("Moving card before position "+insIdx+"  using selector "+listSelector),$(listSelector).eq(idx).before(cardEl)):(log.debug("Moving card after position "+cardEls.length+" using selector "+listSelector),$(listSelector).eq(cardEls.length-1).after(cardEl)):(log.debug("Destination "+listSelector+" empty"),prependWhenEmpty?(log.debug("prepending to "+listSelectorWhenEmpty),$(listSelectorWhenEmpty).prepend(cardEl)):(log.debug("appending to "+listSelectorWhenEmpty),$(listSelectorWhenEmpty).append(cardEl))),"function"==typeof onMoveComplete&&onMoveComplete()},favoriteCourse=function(button){if(!$(button).hasClass("ajaxing")){$(button).addClass("ajaxing");var jsid,favorited="true"===$(button).attr("aria-pressed")?0:1,cardEl=$($(button).parents(".coursecard")[0]),shortname=$(cardEl).data("shortname"),doAjax=function(jsid){return ajax.call([{methodname:"theme_snap_course_card",args:{courseshortname:shortname,favorited:favorited},fail:function(response){$(button).removeClass("ajaxing"),ajaxNotify.ifErrorShowBestMsg(response)}}],!0,!0)[0].then((function(response){return function(renderable,cardEl){var dfd=$.Deferred();return mview(cardEl,"theme_snap/course_cards"),$(cardEl).trigger("modelUpdate",[renderable,function(){var button=$(cardEl).find(".favoritetoggle");$(button).removeClass("ajaxing"),$(button).focus()}]),$(cardEl).on("modelUpdated",(function(e){dfd.resolve(e)})),dfd.promise()}(response,cardEl)})).then((function(){M.util.js_complete(jsid)}))};1===favorited?(jsid="favourite_"+(new Date).getTime().toString(16)+Math.floor(1e3*Math.random()),M.util.js_pending(jsid),moveCard(cardEl,"#snap-pm-courses-current-cards .coursecard.favorited","#snap-pm-courses-current-cards",!0,(function(){doAjax(jsid)}))):(jsid="unfavourite_"+(new Date).getTime().toString(16)+Math.floor(1e3*Math.random()),M.util.js_pending(jsid),function(cardEl,onMoveComplete){var container,publishedcount=$('#snap-pm-courses-current .coursecard:not([data-hidden="true"])').length;!0===$(cardEl).data("hidden")&&publishedcount>0?(container="#snap-pm-courses-hidden-cards",$("#snap-pm-courses-hidden").addClass("state-visible"),$("#snap-pm-courses-hidden-cards").collapse("show")):(window.console.log("not a hidden card"),container="#snap-pm-courses-current-cards"),moveCard(cardEl,container+" .coursecard:not(.favorited)",container,!1,onMoveComplete)}(cardEl,(function(){doAjax(jsid)})))}};$("#snap-pm").on("click",".favoritetoggle",(function(e){e.preventDefault(),e.stopPropagation(),favoriteCourse(this)}))}}));

//# sourceMappingURL=pm_course_favorites.min.js.map